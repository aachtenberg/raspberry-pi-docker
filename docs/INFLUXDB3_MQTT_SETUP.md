# MQTT â†’ InfluxDB 3 Core Integration via Telegraf

## Overview

This guide explains how Telegraf bridges Home Assistant MQTT messages to InfluxDB 3 Core, enabling:
- ðŸ“¡ MQTT sensor data from Home Assistant â†’ Telegraf â†’ InfluxDB 3
- ðŸ”„ Automatic JSON â†’ Line Protocol transformation
- ðŸ“Š Real-time data ingestion without modifying Home Assistant config
- ðŸ”Œ No breaking changes to existing InfluxDB 2.7 pipeline

## Architecture

```
Home Assistant
    â†“ (publishes JSON)
Mosquitto (MQTT Broker)
    â†“ (subscribes to homeassistant/sensor/+/state)
Telegraf (transform + batch)
    â†“ (HTTP POST with bearer token)
InfluxDB 3 Core (homeassistant bucket)
    â†“ (query via SQL)
Grafana Dashboard or Explorer UI
```

## Quick Start

### 1. Generate InfluxDB 3 Admin Token

If not already done:

```bash
docker compose exec influxdb3-core influxdb3 create token --admin
```

**Output:**
```
Token: INFLUXDB3_TOKEN_PLACEHOLDER
```

### 2. Store Token in `.env`

Add to your local `.env` file (do NOT commit):

```bash
echo "INFLUXDB3_ADMIN_TOKEN=<influxdb3_token>" >> .env
```

### 3. Start Telegraf

```bash
docker compose up -d telegraf
```

### 4. Verify Services

```bash
# Check Telegraf is running
docker compose ps telegraf

# View logs
docker compose logs -f telegraf

# Expected output: "outputs.influxdb_v2: wrote N metrics"
```

### 5. Publish Test MQTT Message

```bash
docker compose exec mosquitto mosquitto_pub \
  -t "homeassistant/sensor/living_room_temp/state" \
  -m '{"state": "22.5", "attributes": {"unit_of_measurement": "Â°C", "friendly_name": "Living Room Temperature"}}'
```

### 6. Query in InfluxDB 3 Explorer

1. Open `http://localhost:8888`
2. Select `homeassistant` database
3. Run query:
   ```sql
   SELECT time, device_id, value, unit FROM mqtt_event LIMIT 10
   ```

## Configuration

### Telegraf Configuration File

Location: `telegraf/telegraf.conf`

**Key sections:**

#### MQTT Input
```toml
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = [
    "homeassistant/sensor/+/state",
    "homeassistant/binary_sensor/+/state",
    "homeassistant/climate/+/state"
  ]
  data_format = "json"
```

**Topic patterns supported:**
- `homeassistant/sensor/*/state` - Temperature, humidity, pressure, etc.
- `homeassistant/binary_sensor/*/state` - Motion, door/window, etc.
- `homeassistant/climate/*/state` - Thermostat state

#### JSON Parsing
Home Assistant sends payloads like:
```json
{
  "state": "22.5",
  "attributes": {
    "unit_of_measurement": "Â°C",
    "friendly_name": "Living Room Temp"
  }
}
```

Telegraf extracts:
- `state` â†’ `value` field (float)
- `unit_of_measurement` â†’ `unit` tag
- `friendly_name` â†’ `name` tag
- MQTT topic â†’ `device_id` tag (via regex)

#### InfluxDB 3 Output
```toml
[[outputs.influxdb_v2]]
  urls = ["http://influxdb3-core:8181"]
  token = "${INFLUXDB3_ADMIN_TOKEN}"
  bucket = "homeassistant"
```

**Writes to:**
- **Database**: `homeassistant` (auto-created on first write if doesn't exist)
- **Measurement**: `mqtt_event`
- **Tags**: `device_id`, `unit`, `name`, `sensor_type`
- **Fields**: `value` (numeric sensor reading)

## Data Flow Examples

### Example 1: Temperature Sensor

**MQTT Message:**
```
Topic: homeassistant/sensor/bedroom_temp/state
Payload: {"state": "21.5", "attributes": {"unit_of_measurement": "Â°C", "friendly_name": "Bedroom Temperature"}}
```

**InfluxDB 3 Line Protocol (generated by Telegraf):**
```
mqtt_event,device_id=bedroom_temp,unit=Â°C,name=Bedroom\ Temperature value=21.5 1701100800000000000
```

**Query:**
```sql
SELECT time, name, value, unit FROM mqtt_event WHERE device_id = 'bedroom_temp' LIMIT 100
```

### Example 2: Motion Sensor

**MQTT Message:**
```
Topic: homeassistant/binary_sensor/hallway_motion/state
Payload: {"state": "on", "attributes": {"friendly_name": "Hallway Motion"}}
```

**InfluxDB 3 Result:**
```
mqtt_event,device_id=hallway_motion,name=Hallway\ Motion value=on
```

## Grafana Integration

### Create Dashboard for MQTT Data

1. Open Grafana (http://localhost:3000)
2. **Datasource**: Select **InfluxDB 3 Core** (if not configured, add it)
   - URL: `http://influxdb3-core:8181`
   - Token: `${INFLUXDB3_ADMIN_TOKEN}` (from environment)
3. **New Panel** â†’ **Query**
4. Write SQL query:

```sql
SELECT 
  time,
  name,
  value,
  unit
FROM mqtt_event
WHERE time > now() - interval '24 hours'
  AND sensor_type = 'sensor'
ORDER BY time DESC
LIMIT 1000
```

5. **Visualize** as Time Series, Gauge, or Table

### Example Dashboard Queries

**Latest temperature in each room:**
```sql
SELECT 
  LAST(value) as temp,
  name,
  unit
FROM mqtt_event
WHERE sensor_type = 'sensor'
GROUP BY device_id, name, unit
```

**Temperature trend over 24 hours:**
```sql
SELECT 
  time,
  value,
  name
FROM mqtt_event
WHERE sensor_type = 'sensor'
  AND name LIKE '%Temp%'
  AND time > now() - interval '24 hours'
ORDER BY time
```

## Home Assistant Configuration

### Enable MQTT Discovery

Ensure Home Assistant publishes sensor states to MQTT:

**configuration.yaml:**
```yaml
homeassistant:
  # ...

mqtt:
  broker: mosquitto  # or IP address if on different network
  port: 1883
  client_id: home-assistant
  username: "" # if auth required
  password: "" # if auth required

# Ensure sensors publish to MQTT
automation:
  - alias: "Publish sensor state to MQTT"
    trigger:
      platform: time_pattern
      minutes: "/5"  # Every 5 minutes
    action:
      service: mqtt.publish
      data:
        topic: "homeassistant/sensor/{{ trigger.entity_id }}/state"
        payload: |
          {
            "state": "{{ state_attr(entity_id, 'state') }}",
            "attributes": {
              "unit_of_measurement": "{{ state_attr(entity_id, 'unit_of_measurement') }}",
              "friendly_name": "{{ state_attr(entity_id, 'friendly_name') }}"
            }
          }
```

## Troubleshooting

### Telegraf Won't Start

**Check logs:**
```bash
docker compose logs -f telegraf
```

**Common errors:**

| Error | Solution |
|-------|----------|
| `Connection refused` (Mosquitto) | Ensure Mosquitto is running: `docker compose ps mosquitto` |
| `Connection refused` (InfluxDB 3) | Ensure InfluxDB 3 Core is running: `docker compose ps influxdb3-core` |
| `401 Unauthorized` | Token is invalid or missing. Verify `INFLUXDB3_ADMIN_TOKEN` in `.env` |
| `Config parse error` | Check `telegraf/telegraf.conf` syntax; try: `telegraf --config ./telegraf/telegraf.conf --test` |

### No Data Appearing in InfluxDB 3

**Step 1: Verify MQTT message is published**
```bash
# Subscribe to test topic
docker compose exec mosquitto mosquitto_sub \
  -t "homeassistant/sensor/+/state" -v
```

**Step 2: Check Telegraf logs for parse errors**
```bash
docker compose logs telegraf | grep -i error
```

**Step 3: Manually test Telegraf config**
```bash
docker compose exec telegraf telegraf --config /etc/telegraf/telegraf.conf --test
```

**Step 4: Verify token works**
```bash
TOKEN=$(grep INFLUXDB3_ADMIN_TOKEN .env | cut -d= -f2)
curl -s -X POST http://localhost:8181/api/v1/query \
  -H "Authorization: Bearer ${TOKEN}" \
  -d 'SELECT * FROM mqtt_event LIMIT 1'
```

### Telegraf Writing But No Data in Database

**Check if bucket exists:**
```bash
TOKEN=$(grep INFLUXDB3_ADMIN_TOKEN .env | cut -d= -f2)
docker compose exec influxdb3-core influxdb3 show databases --token "${TOKEN}"
```

**Create bucket if missing:**
```bash
TOKEN=$(grep INFLUXDB3_ADMIN_TOKEN .env | cut -d= -f2)
docker compose exec influxdb3-core influxdb3 create database homeassistant --token "${TOKEN}"
```

### High CPU/Memory Usage

Telegraf batches metrics to reduce overhead. Adjust batch settings in `telegraf.conf`:

```toml
[[outputs.influxdb_v2]]
  batch_size = 100        # Lower = more frequent writes, higher = more buffering
  batch_timeout = "1s"    # Wait max 1s before flushing batch
```

## Performance Tuning

### Increase Metric Batch Size

For high-volume MQTT sensors, increase batching:

```toml
[agent]
  metric_batch_size = 5000
  metric_buffer_limit = 50000

[[outputs.influxdb_v2]]
  batch_size = 500
  batch_timeout = "5s"
```

### Filter Specific Topics

Only subscribe to needed topics to reduce processing:

```toml
[[inputs.mqtt_consumer]]
  topics = [
    "homeassistant/sensor/bedroom_temp/state",
    "homeassistant/sensor/living_room_humidity/state"
  ]
```

### Add Sampling

Skip some metrics if volume is too high:

```toml
[[processors.sampling]]
  sample_interval = 10  # Keep 1 of every 10 messages
```

## Advanced: Custom Data Transformation

### Extract Custom Tags from MQTT Topic

Edit `telegraf/telegraf.conf` processor to map device location:

```toml
[[processors.regex]]
  [[processors.regex.tags]]
    key = "topic"
    pattern = "homeassistant/sensor/([^_]+)_(.+)_"
    replacement = "${1}"
    result_key = "location"
```

**Example:** Topic `homeassistant/sensor/bedroom_temp_celsius/state` â†’ tag `location=bedroom`

### Add Custom Tags

Add static tags to all metrics:

```toml
[global_tags]
  source = "mqtt"
  building = "main"
  floor = "1"
```

### Timestamp Handling

Use MQTT publish time instead of Telegraf receive time:

```toml
[[inputs.mqtt_consumer]]
  timestamp_path = "@timestamp"
  timestamp_format = "unix_ms"
```

## Monitoring Telegraf

### Check Metrics Written

```bash
docker compose logs telegraf | grep "outputs.influxdb_v2"
```

**Example output:**
```
telegraf: outputs.influxdb_v2: wrote 5 metrics
```

### Query Written Metrics

```bash
TOKEN=$(grep INFLUXDB3_ADMIN_TOKEN .env | cut -d= -f2)
docker compose exec influxdb3-core influxdb3 query homeassistant \
  --token "${TOKEN}" \
  "SELECT COUNT(*) FROM mqtt_event"
```

## Migration from InfluxDB 2.7

If migrating existing MQTT data:

1. **Ensure both databases run in parallel** (already configured)
2. **Telegraf writes only to InfluxDB 3** (configured in telegraf.conf)
3. **Update Grafana datasources** to point to InfluxDB 3 for MQTT queries
4. **Gradual migration**: Keep InfluxDB 2.7 for legacy data, new MQTT â†’ v3

## Useful Links

- **Telegraf Documentation**: https://docs.influxdata.com/telegraf/latest/
- **MQTT Consumer Plugin**: https://docs.influxdata.com/telegraf/latest/plugins/inputs/mqtt_consumer/
- **InfluxDB 3 API**: https://docs.influxdata.com/influxdb3/core/api/
- **Home Assistant MQTT**: https://www.home-assistant.io/integrations/mqtt/
- **InfluxDB Line Protocol**: https://docs.influxdata.com/influxdb/v2.7/reference/line-protocol/

## Support

For issues:
1. Check `docs/INFLUXDB3_SETUP.md` for InfluxDB 3 Core troubleshooting
2. Review Telegraf logs: `docker compose logs telegraf`
3. Verify MQTT connectivity: `docker compose exec mosquitto mosquitto_sub -t "homeassistant/#" -v`
4. Test token: `docker compose exec influxdb3-core influxdb3 show databases --token "${TOKEN}"`

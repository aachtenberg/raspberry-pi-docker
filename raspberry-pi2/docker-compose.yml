# Docker Compose for raspberrypi2 (set your LAN host/IP, e.g., raspberrypi2.local)
# Monitoring exporters only - system and Docker metrics

services:
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    ports:
      - '9100:9100'
    command:
      - '--path.rootfs=/host'
      - '--collector.textfile.directory=/textfile_collector'
    volumes:
      - /:/host:ro,rslave
      - /var/lib/node_exporter/textfile_collector:/textfile_collector:ro
    networks:
      - monitoring

  telegraf:
    image: telegraf:latest
    container_name: telegraf
    restart: unless-stopped
    user: "0:984"  # Run as root with docker group to access Docker socket
    ports:
      - "9273:9273"  # Expose Telegraf metrics endpoint
    networks:
      - monitoring
    volumes:
      - ./telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: timescaledb
    restart: unless-stopped
    ports:
      - '5433:5432'
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - timescaledb-data:/var/lib/postgresql/data
    networks:
      - monitoring

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter
    restart: unless-stopped
    ports:
      - '9188:9187'
    environment:
      - DATA_SOURCE_NAME=postgresql://postgres:${POSTGRES_PASSWORD}@timescaledb:5432/postgres?sslmode=disable
    networks:
      - monitoring
    depends_on:
      - timescaledb

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    restart: unless-stopped
    ports:
      - "9080:9080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./promtail-config.yml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    networks:
      - monitoring

  ai-monitor:
    build:
      context: ../ai-monitor
      dockerfile: Dockerfile
    container_name: ai-monitor-pi2
    restart: unless-stopped
    ports:
      - '8001:8000'  # Different port from Pi1 (8000 is used there)
    environment:
      - PROMETHEUS_URL=${AI_MONITOR_PROMETHEUS_URL:-http://192.168.0.167:9090}  # Pi1's Prometheus
      - AI_MONITOR_INTERVAL_SECONDS=${AI_MONITOR_INTERVAL_SECONDS:-60}
      - AI_MONITOR_EXECUTE=${AI_MONITOR_EXECUTE:-false}
      - AI_MONITOR_ALLOWED_CONTAINERS=${AI_MONITOR_ALLOWED_CONTAINERS_PI2:-telegraf,promtail}
      - AI_MONITOR_LOG_LEVEL=${AI_MONITOR_LOG_LEVEL:-info}
      - AI_MONITOR_PREDICTIVE_ENABLED=${AI_MONITOR_PREDICTIVE_ENABLED:-false}
      - AI_MONITOR_PREDICTIVE_INTERVAL_SECONDS=${AI_MONITOR_PREDICTIVE_INTERVAL_SECONDS:-86400}
      - AI_MONITOR_INCIDENT_REPORTS_ENABLED=${AI_MONITOR_INCIDENT_REPORTS_ENABLED:-true}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY:-}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-3-haiku-20240307}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.0-flash-exp}
      - AI_MONITOR_HTTP_CHECKS=${AI_MONITOR_HTTP_CHECKS_PI2:-http://camera-dashboard-api-1:8080|200;http://camera-dashboard-web-1:80|200}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Pi2's local Docker socket
      - ./ai-monitor-incidents:/app/incidents  # Separate incident dir for Pi2
    networks:
      - monitoring
      - camera-dashboard_default  # For HTTP checks to camera dashboard services

volumes:
  timescaledb-data:

networks:
  monitoring:
    driver: bridge
  camera-dashboard_default:
    external: true  # Connect to camera-dashboard network for HTTP checks

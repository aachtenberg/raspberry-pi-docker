# Telegraf Configuration for MQTT â†’ InfluxDB 3 Core Bridge
# Consumes Home Assistant MQTT sensor data and writes to InfluxDB 3
# 
# Reference: https://docs.influxdata.com/telegraf/latest/

[global_tags]
  # Tags applied to all metrics
  source = "mqtt"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  debug = true
  quiet = false
  logfile = ""
  hostname = "telegraf"
  omit_hostname = false

# ==============================================================================
# INPUT PLUGINS - MQTT Consumer
# ==============================================================================

[[inputs.mqtt_consumer]]
  # Mosquitto broker address (host network uses localhost IP)
  servers = ["tcp://127.0.0.1:1883"]
  
  # Home Assistant sensor topics + Surveillance topics
  topics = [
    "homeassistant/sensor/+/state",
    "surveillance/#"
  ]
  
  # MQTT connection settings
  qos = 0
  connection_timeout = "30s"
  
  # Parse JSON - all fields become metric fields
  data_format = "json"
  
  # Set measurement name for surveillance data
  name_override = "surveillance"
  
  # Extract topic as tag for filtering
  [inputs.mqtt_consumer.tags]
    topic = "${topic}"

# ==============================================================================
# OUTPUT PLUGINS - InfluxDB 3 Core (via HTTP API)
# ==============================================================================

[[outputs.http]]
  # InfluxDB 3 Core write API endpoint for homeassistant data
  url = "http://localhost:8181/write?db=homeassistant"
  method = "POST"
  data_format = "influx"
  
  # Bearer token authentication
  [outputs.http.headers]
    Authorization = "Bearer ${INFLUXDB3_ADMIN_TOKEN}"
    Content-Type = "text/plain; charset=utf-8"

[[outputs.http]]
  # InfluxDB 3 Core write API endpoint for surveillance data
  url = "http://localhost:8181/write?db=surveillance"
  method = "POST"
  data_format = "influx"
  
  # Bearer token authentication
  [outputs.http.headers]
    Authorization = "Bearer ${INFLUXDB3_ADMIN_TOKEN}"
    Content-Type = "text/plain; charset=utf-8"
# Telegraf Configuration for MQTT â†’ InfluxDB 3 Core Bridge
# Consumes Home Assistant MQTT sensor data and writes to InfluxDB 3
# 
# Reference: https://docs.influxdata.com/telegraf/latest/

[global_tags]
  # Tags applied to all metrics
  source = "mqtt"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  debug = true
  quiet = false
  logfile = ""
  hostname = "telegraf"
  omit_hostname = false

# ==============================================================================
# INPUT PLUGINS - MQTT Consumer
# ==============================================================================

[[inputs.mqtt_consumer]]
  # Mosquitto broker address (host network uses localhost IP)
  servers = ["tcp://127.0.0.1:1883"]
  
  # Home Assistant sensor topics
  topics = ["homeassistant/sensor/+/state"]
  
  # MQTT connection settings
  qos = 0
  connection_timeout = "30s"
  
  # Parse JSON - all fields become metric fields
  data_format = "json"
  
  # Set measurement name for home assistant data
  name_override = "mqtt_sensor"
  
  # Extract topic as tag for filtering
  [inputs.mqtt_consumer.tags]
    topic = "${topic}"

# Separate MQTT input for surveillance topics
[[inputs.mqtt_consumer]]
  # Mosquitto broker address (host network uses localhost IP)
  servers = ["tcp://127.0.0.1:1883"]
  
  # Surveillance camera topics
  topics = ["surveillance/#"]
  
  # MQTT connection settings
  qos = 0
  connection_timeout = "30s"
  
  # Parse JSON - all fields become metric fields
  data_format = "json"
  
  # Set measurement name for surveillance data
  name_override = "surveillance"
  
  # Capture string fields as tags (chip_id, version, device, etc.)
  json_string_fields = ["chip_id", "version", "device"]
  
  # Extract topic as tag for filtering
  [inputs.mqtt_consumer.tags]
    topic = "${topic}"

# ESP Sensor Hub - temperature readings (numeric value payloads)
[[inputs.mqtt_consumer]]
  servers = ["tcp://127.0.0.1:1883"]
  topics = ["esp-sensor-hub/+/temperature"]
  qos = 0
  connection_timeout = "30s"
  data_format = "json"
  tag_keys = ["device", "chip_id"]
  name_override = "esp_temperature"
  [inputs.mqtt_consumer.tags]
    topic = "${topic}"

# ESP Sensor Hub - event messages (JSON payloads)
[[inputs.mqtt_consumer]]
  servers = ["tcp://127.0.0.1:1883"]
  topics = ["esp-sensor-hub/+/events"]
  qos = 0
  connection_timeout = "30s"
  data_format = "json"
  name_override = "esp_events"
  # treat device as tag; remaining are fields
  tag_keys = ["device"]
  json_string_fields = ["event", "message", "status"]
  [inputs.mqtt_consumer.tags]
    topic = "${topic}"

# ==============================================================================
# OUTPUT PLUGINS - InfluxDB 3 Core (via HTTP API)
# ==============================================================================

# ==============================================================================
# PROCESSORS - Extract device id from topic
# ==============================================================================

[[processors.regex]]
  # Only apply to ESP Sensor Hub measurements
  namepass = ["esp_temperature", "esp_events"]

  # Extract device id from the MQTT topic into 'device' tag
  [[processors.regex.tags]]
    key = "topic"
    pattern = "^esp-sensor-hub/([^/]+)/.*$"
    replacement = "${1}"
    result_key = "device"

[[outputs.http]]
  # InfluxDB 3 Core write API endpoint for homeassistant data
  url = "http://localhost:8181/write?db=homeassistant"
  method = "POST"
  data_format = "influx"
  namepass = ["mqtt_sensor"]
  
  # Bearer token authentication
  [outputs.http.headers]
    Authorization = "Bearer ${INFLUXDB3_ADMIN_TOKEN}"
    Content-Type = "text/plain; charset=utf-8"

[[outputs.http]]
  # InfluxDB 3 Core write API endpoint for surveillance data
  url = "http://localhost:8181/write?db=surveillance"
  method = "POST"
  data_format = "influx"
  namepass = ["surveillance"]
  
  # Bearer token authentication
  [outputs.http.headers]
    Authorization = "Bearer ${INFLUXDB3_ADMIN_TOKEN}"
    Content-Type = "text/plain; charset=utf-8"

[[outputs.http]]
  # InfluxDB 3 Core write API endpoint for ESP Sensor Hub temperature/events
  url = "http://localhost:8181/write?db=temperature_data"
  method = "POST"
  data_format = "influx"
  namepass = ["esp_temperature", "esp_events"]
  [outputs.http.headers]
    Authorization = "Bearer ${INFLUXDB3_ADMIN_TOKEN}"
    Content-Type = "text/plain; charset=utf-8"
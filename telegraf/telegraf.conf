# Telegraf Configuration for MQTT â†’ InfluxDB 3 Core Bridge
# Consumes ESP Sensor Hub and Surveillance MQTT data and writes to InfluxDB 3
# 
# Reference: https://docs.influxdata.com/telegraf/latest/

[global_tags]
  # Tags applied to all metrics
  source = "mqtt"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  debug = true
  quiet = false
  logfile = ""
  hostname = "telegraf"
  omit_hostname = false

# ==============================================================================
# INPUT PLUGINS - MQTT Consumer
# ==============================================================================

# REMOVED: Home Assistant input - not used by ESP temperature sensors
# ESP sensors publish to esp-sensor-hub/+/temperature (configured below)

# ==============================================================================
# INPUT PLUGINS - Telegraf Internal Metrics
# ==============================================================================

[[inputs.internal]]
  # Collect Telegraf internal metrics (write stats, gather time, etc.)
  # These metrics track plugin performance and health
  collect_memstats = true

# ==============================================================================
# INPUT PLUGINS - Docker Container Metrics
# ==============================================================================

[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  gather_services = false
  source_tag = false
  container_name_include = []
  container_name_exclude = []
  timeout = "5s"
  docker_label_include = ["com.docker.compose.service", "com.docker.compose.project"]
  tag_env = []

# Separate MQTT input for surveillance topics
[[inputs.mqtt_consumer]]
  # Mosquitto broker address (host network uses localhost IP)
  servers = ["tcp://mosquitto-broker:1883"]
  
  # Surveillance camera topics
  topics = ["surveillance/#"]
  
  # MQTT connection settings
  qos = 0
  connection_timeout = "30s"
  
  # Parse JSON - all fields become metric fields
  data_format = "json"
  
  # Set measurement name for surveillance data
  name_override = "surveillance"
  
  # Capture string fields as tags (chip_id, version, device, etc.)
  # Note: uptime, uptime_seconds are numeric fields, not strings
  json_string_fields = ["chip_id", "version", "device", "ip", "boot_reason", "location"]
  
  # Extract topic as tag for filtering
  [inputs.mqtt_consumer.tags]
    topic = "${topic}"

# ESP Sensor Hub - temperature readings (numeric value payloads)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto-broker:1883"]
  topics = ["esp-sensor-hub/+/temperature"]
  qos = 0
  connection_timeout = "30s"
  data_format = "json"
  tag_keys = ["device", "chip_id"]
  json_string_fields = ["trace_id", "traceparent"]
  name_override = "esp_temperature"
  [inputs.mqtt_consumer.tags]
    topic = "${topic}"

# ESP Sensor Hub - event messages (JSON payloads)
# DISABLED: ESP devices don't currently publish to events topic
# [[inputs.mqtt_consumer]]
#   servers = ["tcp://mosquitto-broker:1883"]
#   topics = ["esp-sensor-hub/+/events"]
#   qos = 0
#   connection_timeout = "30s"
#   data_format = "json"
#   name_override = "esp_events"
#   # treat device as tag; remaining are fields
#   tag_keys = ["device"]
#   json_string_fields = ["event", "message", "status"]
#   [inputs.mqtt_consumer.tags]
#     topic = "${topic}"

# ==============================================================================
# OUTPUT PLUGINS - InfluxDB 3 Core (via HTTP API)
# ==============================================================================

# ==============================================================================
# PROCESSORS - Extract device id from topic
# ==============================================================================

[[processors.regex]]
  # Only apply to ESP Sensor Hub measurements
  namepass = ["esp_temperature", "esp_events"]

  # Extract device id from the MQTT topic into 'device' tag
  [[processors.regex.tags]]
    key = "topic"
    pattern = "^esp-sensor-hub/([^/]+)/.*$"
    replacement = "${1}"
    result_key = "device"

# REMOVED: Home Assistant output - not used by this system
# ESP temperature data goes to temperature_data database (configured below)

[[outputs.http]]
  # InfluxDB 3 Core write API endpoint for surveillance data
  url = "http://192.168.0.167:8181/write?db=surveillance"
  method = "POST"
  data_format = "influx"
  namepass = ["surveillance"]

  # Timeout and retry settings to prevent backup
  timeout = "10s"

  # Bearer token authentication
  [outputs.http.headers]
    Authorization = "Bearer ${INFLUXDB3_ADMIN_TOKEN}"
    Content-Type = "text/plain; charset=utf-8"

[[outputs.http]]
  # InfluxDB 3 Core write API endpoint for ESP Sensor Hub temperature data
  url = "http://192.168.0.167:8181/write?db=temperature_data"
  method = "POST"
  data_format = "influx"
  namepass = ["esp_temperature"]

  # Timeout and retry settings to prevent backup
  timeout = "10s"

  [outputs.http.headers]
    Authorization = "Bearer ${INFLUXDB3_ADMIN_TOKEN}"
    Content-Type = "text/plain; charset=utf-8"

# ==============================================================================
# OUTPUT PLUGINS - Prometheus Metrics Endpoint
# ==============================================================================

[[outputs.prometheus_client]]
  # Expose Telegraf metrics on /metrics endpoint
  listen = ":9273"
  path = "/metrics"
  
  # Include basic Telegraf internal metrics
  collectors_exclude = ["gocollector", "process"]
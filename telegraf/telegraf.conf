# Telegraf Configuration for MQTT â†’ InfluxDB 3 Core Bridge
# Consumes Home Assistant MQTT sensor data and writes to InfluxDB 3
# 
# Reference: https://docs.influxdata.com/telegraf/latest/

[global_tags]
  # Tags applied to all metrics
  source = "mqtt"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  debug = true
  quiet = false
  logfile = ""
  hostname = "telegraf"
  omit_hostname = false

# ==============================================================================
# INPUT PLUGINS - MQTT Consumer
# ==============================================================================

[[inputs.mqtt_consumer]]
  # Mosquitto broker address (host network uses localhost IP)
  servers = ["tcp://127.0.0.1:1883"]
  
  # Home Assistant sensor topics
  topics = [
    "homeassistant/sensor/+/state"
  ]
  
  # MQTT connection settings
  qos = 0
  connection_timeout = "30s"
  
  # Parse JSON and extract state field
  data_format = "json_v2"
  
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "mqtt_sensor"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "state"
      type = "float"

# ==============================================================================
# OUTPUT PLUGINS - InfluxDB 3 Core (via HTTP API)
# ==============================================================================

[[outputs.http]]
  # InfluxDB 3 Core write API endpoint
  url = "http://localhost:8181/write?db=homeassistant"
  method = "POST"
  data_format = "influx"
  
  # Bearer token authentication
  [outputs.http.headers]
    Authorization = "Bearer ${INFLUXDB3_ADMIN_TOKEN}"
    Content-Type = "text/plain; charset=utf-8"
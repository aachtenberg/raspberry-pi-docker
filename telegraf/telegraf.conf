# Telegraf Configuration for MQTT → InfluxDB 3 Core Bridge
# Consumes ESP Sensor Hub and Surveillance MQTT data and writes to InfluxDB 3
# 
# Reference: https://docs.influxdata.com/telegraf/latest/

[global_tags]
  # Tags applied to all metrics
  source = "mqtt"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  debug = true
  quiet = false
  logfile = ""
  hostname = "telegraf"
  omit_hostname = false

# ==============================================================================
# INPUT PLUGINS - MQTT Consumer
# ==============================================================================

# REMOVED: Home Assistant input - not used by ESP temperature sensors
# ESP sensors publish to esp-sensor-hub/+/temperature (configured below)

# ==============================================================================
# INPUT PLUGINS - Telegraf Internal Metrics
# ==============================================================================

[[inputs.internal]]
  # Collect Telegraf internal metrics (write stats, gather time, etc.)
  # These metrics track plugin performance and health
  collect_memstats = true

# ==============================================================================
# INPUT PLUGINS - Docker Container Metrics
# ==============================================================================

[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  gather_services = false
  source_tag = false
  container_name_include = []
  container_name_exclude = []
  timeout = "5s"
  docker_label_include = ["com.docker.compose.service", "com.docker.compose.project"]
  tag_env = []

# Separate MQTT input for surveillance topics
[[inputs.mqtt_consumer]]
  # Mosquitto broker address (host network uses localhost IP)
  servers = ["tcp://mosquitto-broker:1883"]

  # Surveillance camera topics
  topics = ["surveillance/#"]

  # MQTT connection settings
  qos = 0
  connection_timeout = "30s"

  # Parse JSON - all fields become metric fields
  data_format = "json"

  # Set measurement name for surveillance data
  name_override = "surveillance"

  # Capture string fields (device, version, ip are strings in surveillance messages)
  # Drop 'uptime' field (human-readable string) - use uptime_seconds (numeric) instead
  json_string_fields = ["device", "version", "ip"]

  # Drop the uptime field - uptime_seconds is numeric and preferred
  fielddrop = ["uptime"]

  # Extract topic as tag for filtering
  [inputs.mqtt_consumer.tags]
    topic = "${topic}"

# Mosquitto $SYS broker statistics - numeric metrics only
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto-broker:1883"]
  topics = [
    "$SYS/broker/clients/+",
    "$SYS/broker/messages/+",
    "$SYS/broker/bytes/+",
    "$SYS/broker/load/+/+/+",
    "$SYS/broker/subscriptions/count",
    "$SYS/broker/uptime",
    "$SYS/broker/heap/+"
  ]
  qos = 0
  connection_timeout = "30s"
  data_format = "value"
  data_type = "float"
  name_override = "mosquitto"
  [inputs.mqtt_consumer.tags]
    topic = "${topic}"

# ESP Sensor Hub - temperature readings (numeric value payloads)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto-broker:1883"]
  topics = ["esp-sensor-hub/+/temperature"]
  qos = 0
  connection_timeout = "30s"
  data_format = "json"
  tag_keys = ["device", "chip_id"]
  json_string_fields = ["trace_id", "traceparent"]
  name_override = "esp_temperature"
  [inputs.mqtt_consumer.tags]
    topic = "${topic}"

# ESP Sensor Hub - status/health (battery voltage, wifi, uptime, heap)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto-broker:1883"]
  topics = ["esp-sensor-hub/+/status"]
  qos = 0
  connection_timeout = "30s"
  data_format = "json"
  tag_keys = ["device", "chip_id"]
  json_string_fields = ["trace_id", "traceparent"]
  name_override = "esp_status"
  [inputs.mqtt_consumer.tags]
    topic = "${topic}"

# ESP Sensor Hub - event messages (JSON payloads)
# DISABLED: ESP devices don't currently publish to events topic
# [[inputs.mqtt_consumer]]
#   servers = ["tcp://mosquitto-broker:1883"]
#   topics = ["esp-sensor-hub/+/events"]
#   qos = 0
#   connection_timeout = "30s"
#   data_format = "json"
#   name_override = "esp_events"
#   # treat device as tag; remaining are fields
#   tag_keys = ["device"]
#   json_string_fields = ["event", "message", "status"]
#   [inputs.mqtt_consumer.tags]
#     topic = "${topic}"

# ==============================================================================
# OUTPUT PLUGINS - InfluxDB 3 Core (via HTTP API)
# ==============================================================================

# ==============================================================================
# PROCESSORS - Clean trace_id format for Jaeger compatibility
# ==============================================================================

# Remove dashes from trace_id UUIDs so they're compatible with Jaeger (32 hex chars max)
[[processors.regex]]
  # Only apply to ESP Sensor Hub measurements
  namepass = ["esp_temperature", "esp_status"]

  # Remove dashes from trace_id field (UUID → 32 hex chars)
  # Input:  14d83e05-613c-0000-0027-002700000027
  # Output: 14d83e05613c00000027002700000027
  [[processors.regex.fields]]
    key = "trace_id"
    pattern = "-"
    replacement = ""
    result_key = "trace_id"

# ==============================================================================
# PROCESSORS - Extract device id from topic
# ==============================================================================

[[processors.regex]]
  # Only apply to ESP Sensor Hub measurements
  namepass = ["esp_temperature", "esp_status", "esp_events"]

  # Extract device id from the MQTT topic into 'device' tag
  [[processors.regex.tags]]
    key = "topic"
    pattern = "^esp-sensor-hub/([^/]+)/.*$"
    replacement = "${1}"
    result_key = "device"

# REMOVED: Home Assistant output - not used by this system
# ESP temperature data goes to temperature_data database (configured below)

[[outputs.http]]
  # InfluxDB 3 Core write API endpoint for surveillance data
  url = "http://influxdb3-core:8181/write?db=surveillance"
  method = "POST"
  data_format = "influx"
  namepass = ["surveillance"]

  # Timeout and retry settings to prevent backup
  timeout = "10s"

  # Bearer token authentication
  [outputs.http.headers]
    Authorization = "Bearer ${INFLUXDB3_ADMIN_TOKEN}"
    Content-Type = "text/plain; charset=utf-8"

[[outputs.http]]
  # InfluxDB 3 Core write API endpoint for ESP Sensor Hub temperature data
  url = "http://influxdb3-core:8181/write?db=temperature_data"
  method = "POST"
  data_format = "influx"
  namepass = ["esp_temperature", "esp_status"]

  # Timeout and retry settings to prevent backup
  timeout = "10s"

  [outputs.http.headers]
    Authorization = "Bearer ${INFLUXDB3_ADMIN_TOKEN}"
    Content-Type = "text/plain; charset=utf-8"

# ==============================================================================
# OUTPUT PLUGINS - TimescaleDB (PostgreSQL)
# ==============================================================================

[[outputs.postgresql]]
  # Connection string for TimescaleDB on Pi 2
  connection = "host=192.168.0.146 port=5433 user=postgres password=${POSTGRES_PASSWORD} dbname=postgres sslmode=disable"

  # Schema and Table settings
  schema = "public"

# ==============================================================================
# OUTPUT PLUGINS - Prometheus Metrics Endpoint
# ==============================================================================

[[outputs.prometheus_client]]
  # Expose all metrics (internal + surveillance) on /metrics endpoint
  listen = ":9273"
  path = "/metrics"
  
  # Include basic Telegraf internal metrics
  collectors_exclude = ["gocollector", "process"]
  
  # Preserve string fields as labels for surveillance data
  string_as_label = true
name: Secrets Check

on:
  push:
    # Run on any branch push
    branches:
      - '**'
  pull_request:
    # Run on all PRs targeting any branch
    branches:
      - '**'

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    name: Check for exposed secrets

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fail if .env is committed
        run: |
          if git ls-files --error-unmatch .env >/dev/null 2>&1; then
            echo "❌ .env is tracked in git. Remove it before pushing."
            exit 1
          fi
          echo "✅ .env not tracked"

      - name: Enforce placeholder token file
        run: |
          if [ -f prometheus/influxdb3_token ]; then
            CONTENT=$(cat prometheus/influxdb3_token)
            if [ "$CONTENT" != "INFLUXDB3_TOKEN_PLACEHOLDER" ]; then
              echo "❌ prometheus/influxdb3_token must contain INFLUXDB3_TOKEN_PLACEHOLDER"
              exit 1
            fi
          fi
          echo "✅ Token file placeholder validated"

      - name: Scan repository with gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

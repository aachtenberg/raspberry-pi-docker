name: Secrets Check

on:
  push:
    branches:
      - main
      - develop
      - 'feat/**'
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
      - 'feat/**'
      - 'feature/**'

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    name: Check for exposed secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for .env file
        run: |
          echo "üîç Checking for .env file in repository..."
          if [ -f .env ]; then
            echo "‚ùå ERROR: .env file found in repository!"
            echo "The .env file contains secrets and should never be committed."
            exit 1
          else
            echo "‚úÖ No .env file found"
          fi
      
      - name: Check for secret patterns
        run: |
          echo "üîç Scanning for common secret patterns..."
          
          # Define patterns to search for
          PATTERNS=(
            "CLOUDFLARE_TUNNEL_TOKEN"
            "GRAFANA_API_KEY"
            "GRAFANA_ADMIN_API_KEY"
            "INFLUXDB_ADMIN_TOKEN"
            "INFLUXDB_TOKEN"
            "password.*=.*[^\s]"
            "token.*=.*[^\s]"
            "api_key.*=.*[^\s]"
            "secret.*=.*[^\s]"
          )
          
          FOUND_SECRETS=0
          
          # Exclude certain files/directories from search
          EXCLUDE_DIRS=".git|node_modules|.github"
          
          for pattern in "${PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"
            
            # Search for pattern, excluding certain files and environment variable references
            if git grep -i -E "$pattern" -- . \
              ':!.env.example' \
              ':!.github/workflows/*' \
              ':!scripts/*' \
              ':!docs/*.md' \
              ':!README.md' \
              ':!MAKING_PUBLIC_CHECKLIST.md' \
              ':!.github/copilot-instructions.md' \
              ':!docker-compose.yml' \
              ':!docker-compose.*.yml' \
              ':!*.sql' \
              | grep -v "^#" \
              | grep -v '\${' \
              | grep -E "=.{20,}"; then
              
              echo "‚ö†Ô∏è  Found potential secret with pattern: $pattern"
              FOUND_SECRETS=1
            fi
          done
          
          if [ $FOUND_SECRETS -eq 1 ]; then
            echo ""
            echo "‚ùå ERROR: Potential secrets detected in repository!"
            echo "Please review the files above and ensure no real secrets are committed."
            echo "Use .env file for secrets (which is gitignored)."
            exit 1
          else
            echo "‚úÖ No secrets detected"
          fi
      
      - name: Check for large token values
        run: |
          echo "üîç Checking for suspiciously long token-like strings..."
          
          # Look for base64-like strings that might be tokens (40+ chars)
          if git grep -E '[A-Za-z0-9+/]{40,}={0,2}' -- . \
            ':!.env.example' \
            ':!.github/workflows/*' \
            ':!grafana/dashboards/*.json' \
            ':!package-lock.json' \
            ':!*.md' \
            | head -10; then
            
            echo "‚ö†Ô∏è  Found long token-like strings - please review above"
            echo "Note: This is a warning, not necessarily an error"
          else
            echo "‚úÖ No suspicious token patterns found"
          fi
      
      - name: Verify .gitignore includes .env
        run: |
          echo "üîç Verifying .gitignore configuration..."
          
          if ! grep -q "^\.env$" .gitignore; then
            echo "‚ùå ERROR: .env is not in .gitignore!"
            exit 1
          fi
          
          echo "‚úÖ .gitignore properly configured"
      
      - name: Summary
        if: success()
        run: |
          echo ""
          echo "‚úÖ All security checks passed!"
          echo "No secrets detected in repository."

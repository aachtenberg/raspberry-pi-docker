# Mosquitto MQTT Broker Configuration - Optimized for ESP sensors + Surveillance

# ============================================================================
# LISTENERS
# ============================================================================
# MQTT listener (bind to all interfaces for Docker port mapping)
listener 1883 0.0.0.0
protocol mqtt
allow_anonymous true

# WebSocket listener
listener 9001 0.0.0.0
protocol websockets
allow_anonymous true

# ============================================================================
# PERSISTENCE - Store QoS 1/2 messages and subscriptions
# ============================================================================
persistence true
persistence_location /mosquitto/data/
autosave_interval 300
autosave_on_changes false

# ============================================================================
# MEMORY & QUEUE MANAGEMENT
# ============================================================================
# Max queued messages per client (QoS 1/2)
max_queued_messages 1000

# Max queued bytes per client (10MB)
max_queued_bytes 10485760

# Max inflight QoS 1/2 messages per client
max_inflight_messages 20

# Message size limit (10MB - enough for camera snapshots)
message_size_limit 10485760

# ============================================================================
# CONNECTION LIMITS
# ============================================================================
# Max concurrent connections
max_connections 100

# Connection keepalive - 0 = use client-specified keepalive (better for battery sensors)
max_keepalive 0

# ============================================================================
# LOGGING - Essential for debugging
# ============================================================================
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
log_timestamp true
log_timestamp_format %Y-%m-%dT%H:%M:%S

# Connection logging - helpful for debugging ESP reconnects
connection_messages true

# ============================================================================
# PERFORMANCE TUNING
# ============================================================================
# Retry interval for QoS 1/2 (20 seconds)
retry_interval 20

# Store clean session clients for 5 minutes after disconnect
persistent_client_expiration 5m

# Publish broker statistics to $SYS topics every 10 seconds
sys_interval 10

# ============================================================================
# SECURITY (Future consideration)
# ============================================================================
# Uncomment when ready to add authentication:
# allow_anonymous false
# password_file /mosquitto/config/passwd
# acl_file /mosquitto/config/acl